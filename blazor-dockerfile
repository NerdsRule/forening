FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build
WORKDIR /src

COPY src/Organization.Blazor/Organization.Blazor.csproj src/Organization.Blazor/
COPY src/Organization.Core/Organization.Core.csproj src/Organization.Core/
COPY src/Organization.Infrastructure/Organization.Infrastructure.csproj src/Organization.Infrastructure/
COPY src/Organization.Shared/Organization.Shared.csproj src/Organization.Shared/

RUN dotnet restore src/Organization.Blazor/Organization.Blazor.csproj

COPY src/ src/
WORKDIR /src/src/Organization.Blazor
RUN dotnet publish Organization.Blazor.csproj -c Release -o /app/publish

FROM nginx:alpine AS final
WORKDIR /usr/share/nginx/html

ENV PORT=80
ENV WEBSITES_PORT=80

RUN cat <<'EOF' > /etc/nginx/conf.d/default.conf
server {
	listen 80;
	server_name _;

	root /usr/share/nginx/html;
	index index.html;

	location / {
		try_files $uri $uri/ /index.html;
	}
}
EOF

COPY --from=build /app/publish/wwwroot .
EXPOSE 80
